<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Build a docker image with Argo Workflows" /><meta property="og:locale" content="en" /><meta name="description" content="Building a docker image with Argo Workflows" /><meta property="og:description" content="Building a docker image with Argo Workflows" /><link rel="canonical" href="https://mikenabhan.com/posts/build-docker-image-argo-workflows/" /><meta property="og:url" content="https://mikenabhan.com/posts/build-docker-image-argo-workflows/" /><meta property="og:site_name" content="Mike Nabhan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-26T00:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Build a docker image with Argo Workflows" /><meta name="twitter:site" content="@mikenabhan" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-02-27T22:11:23-07:00","datePublished":"2023-02-26T00:00:00-07:00","description":"Building a docker image with Argo Workflows","headline":"Build a docker image with Argo Workflows","mainEntityOfPage":{"@type":"WebPage","@id":"https://mikenabhan.com/posts/build-docker-image-argo-workflows/"},"url":"https://mikenabhan.com/posts/build-docker-image-argo-workflows/"}</script><title>Build a docker image with Argo Workflows | Mike Nabhan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mike Nabhan"><meta name="application-name" content="Mike Nabhan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://www.gravatar.com/avatar/e1b87ab9c1897f7d1fa78f0ab5a49f3d" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Mike Nabhan</a></div><div class="site-subtitle font-italic">Technical and Professional Writing</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/mikenabhan" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mikenabhan" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['public','mikenabhan.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Build a docker image with Argo Workflows</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Build a docker image with Argo Workflows</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1677394800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 26, 2023 </em> </span> <span> Updated <em class="" data-ts="1677561083" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 27, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/mikenabhan">Mike Nabhan</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2107 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h1 id="building-a-docker-image-with-argo-workflows">Building a docker image with Argo Workflows</h1><p>In this post, we will learn how to build a docker image using Argo Workflows, Kaniko, scan it with Trivy, and push it to an OCI Image repository.</p><h2 id="using-argo-workflows-for-continuous-integration"><span class="mr-2">Using Argo Workflows for Continuous Integration</span><a href="#using-argo-workflows-for-continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>One of the common responsibilities of a DevOps Engineer is maintaining CI/CD for their company. There are many tools with various tradeoffs. Some are free, others are paid, some are fully integrated with your VCS (hopefully git). <a href="https://www.jenkins.io/">Jenkins</a> is the venerable beast most have used at some point. Many of the newer tools are using YAML to abstract away much of what would have been done in groovy with Jenkins. Some examples of these tools in no particular order are <a href="https://docs.gitlab.com/runner/">Gitlab Runners</a>, <a href="https://github.com/features/actions">Github Actions</a>, and <a href="https://www.drone.io/">Drone CI</a>. But what if you want to do CI in a less-proprietary cloud-agnostic Kubernetes native way? Enter <a href="https://argoproj.github.io/argo-workflows/">Argo Workflows</a>.</p><p>In the words of the <a href="https://argoproj.github.io">Argo Project</a>, Argo Workflows is an open source container-native workflow engine for orchestrating parallel jobs on Kubernetes. Argo Workflows can be deployed the same, no matter where you run it. Whether you are in an airgapped on-prem Kubernetes cluster, or a managed Kubernetes cluster with a cloud provider, you can use Argo Workflows the same way. It also recently graduated ðŸŽ“ðŸŽ‰ as a CNCF Project.</p><h3 id="key-features-of-argo-workflows"><span class="mr-2">Key features of Argo Workflows</span><a href="#key-features-of-argo-workflows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Vendor and Cloud Agnostic<li>Directed Acyclic Graphs<li>Kubernetes Native<li>Implemented as CRDs<li>Can be used for many things, like Data Science or Infrastructure as Code implementation</ul><h3 id="wtf-is-a-directed-acyclic-graph"><span class="mr-2">WTF is a Directed Acyclic Graph?</span><a href="#wtf-is-a-directed-acyclic-graph" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A Directed Acyclic Graph or DAG, is a way to define steps or tasks inside of a workflow by declaring its dependencies, as opposed to declaring an explicit order. By doing this, you enable the workflow scheduler to achieve maximum parallelism without having to worry about factors such as the execution time of each individual step.</p><h3 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This tutorial starts off by assuming you have a working install of Argo Workflows and can access the UI. If you donâ€™t have that, you can follow the <a href="https://argoproj.github.io/argo-workflows/quick-start/">official documentation</a>. For this tutorial you do not need to do anything like configuring artifact repositories. You will also need a working Kubeconfig for the cluster that you will be developing, as well as have configured the <a href="https://argoproj.github.io/argo-workflows/quick-start/#install-the-argo-workflows-cli">Argo CLI</a>.</p><h3 id="a-typical-ci-workflow"><span class="mr-2">A typical CI Workflow</span><a href="#a-typical-ci-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A typical Continuous Integration workflow looks something like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>1. Checkout Code
2. Build Code
3. Run Tests
4. Run Security and Vulnerability Scanning
5. Publish/Release Code
</pre></table></code></div></div><h3 id="how-can-we-achieve-this-in-argo-workflows"><span class="mr-2">How can we achieve this in Argo Workflows?</span><a href="#how-can-we-achieve-this-in-argo-workflows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre>---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ci-template
spec:
  entrypoint: ci
  artifactGC:
    strategy: OnWorkflowDeletion
  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 500Mi
  arguments:
    parameters:
      - name: repo
        value: https://github.com/argoproj/argo-workflows.git
      - name: revision
        value: v2.1.1"
      - name: oci-registry
        value: docker.io
      - name: oci-image
        value: templates/workflow
      - name: oci-tag
        value: v1.1.1
      - name: push-image
        value: false
  templates:
    - name: ci
      dag:
        tasks:
          - name: git-clone
            template: git-clone
          - name: ls
            template: ls
            dependencies:
              - git-clone
          - name: build
            template: build
            dependencies:
              - git-clone
              - ls
          - name: trivy-image-scan
            template: trivy-image-scan
            dependencies:
              - build
          - name: trivy-filesystem-scan
            template: trivy-filesystem-scan
            dependencies:
              - build
          - name: push-image
            template: push-image
            when: " == true"
            dependencies:
              - trivy-filesystem-scan
              - trivy-image-scan
    - name: git-clone
      inputs:
        parameters:
          - name: repo
            value: ""
          - name: revision
            value: ""
        artifacts:
          - name: argo-source
            path: /src
            git:
              repo: ""
              revision: ""
      container:
        image: alpine:3.17
        command:
          - sh
          - -c
        args:
          - cp -r /src/* .
        workingDir: /workdir
        volumeMounts:
          - name: workdir
            mountPath: /workdir
    - name: ls
      container:
        image: alpine:3.17
        command:
          - sh
          - -c
        args:
          - ls /
        workingDir: /workdir
        volumeMounts:
          - name: workdir
            mountPath: /workdir
    - name: build
      inputs:
        parameters:
          - name: oci-image
            value: ""
          - name: oci-tag
            value: ""
      container:
        image: gcr.io/kaniko-project/executor:latest
        args:
          - --context=/workdir
          - --destination=:
          - --no-push
          - --tar-path=/workdir/.tar
        workingDir: /workdir
        volumeMounts:
          - name: workdir
            mountPath: /workdir
    - name: trivy-image-scan
      inputs:
        parameters:
          - name: oci-tag
            value: ""
      container:
        image: aquasec/trivy
        args:
          - image
          - --input=/workdir/.tar
        env:
          - name: DOCKER_HOST
            value: tcp://127.0.0.1:2375
        volumeMounts:
          - name: workdir
            mountPath: /workdir
      sidecars:
        - name: dind
          image: docker:23.0.1-dind
          command:
            - dockerd-entrypoint.sh
          env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
          securityContext:
            privileged: true
          mirrorVolumeMounts: true
    - name: trivy-filesystem-scan
      inputs:
        parameters:
          - name: oci-tag
            value: ""
      container:
        image: aquasec/trivy
        args:
          - filesystem
          - /workdir
          - --ignorefile=/workdir/.tar
        volumeMounts:
          - name: workdir
            mountPath: /workdir
    - name: push-image
      inputs:
        parameters:
          - name: oci-tag
            value: ""
          - name: oci-image
            value: ""
          - name: oci-registry
            value: ""
      script:
        image: gcr.io/go-containerregistry/crane:debug
        env:
          - name: OCI_REGISTRY_USER
            valueFrom:
              secretKeyRef:
                name: registry-credentials
                key: username
          - name: OCI_REGISTRY_PASSWORD
            valueFrom:
              secretKeyRef:
                name: registry-credentials
                key: password
        command:
          - sh
        source: &gt;
          crane auth login -u $OCI_REGISTRY_USER -p $OCI_REGISTRY_PASSWORD 
          crane push /workdir/.tar /:
        volumeMounts:
          - name: workdir
            mountPath: /workdir
</pre></table></code></div></div><h3 id="the-breakdown"><span class="mr-2">The Breakdown</span><a href="#the-breakdown" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ci-template
spec:
  entrypoint: ci #Specifies what task the workflow will start on by default
  artifactGC:
    strategy: OnWorkflowDeletion # tells argo to cleanup after itself
  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 500Mi
  arguments:
    parameters:
      - name: repo
        value: https://github.com/argoproj/argo-workflows.git
      - name: revision
        value: v2.1.1"
      - name: oci-registry
        value: docker.io
      - name: oci-image
        value: templates/workflow
      - name: oci-tag
        value: v1.1.1
      - name: push-image
        value: false
</pre></table></code></div></div><p>The VolumeClaimTemplate here is the notable part of this workflow. Instead of configuring an artifact repository, Argo Workflows has a facility to allow for seamlessly mounting a volume across individual steps or tasks in the workflow. This is extremely useful, because each task runs in its own ephemeral container. It also allows the re-use of assets between tasks without having to upload or download from somewhere else, as this is my biggest gripe with artifact caching in Github Actions.</p><p>Below that, I specify workflow level parameters and their default values. These will be the defaults shown in the UI, and can be overridden there or in the on the command line.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>  templates:
    - name: ci
      dag:
        tasks:
          - name: git-clone
            template: git-clone
          - name: ls
            template: ls
            dependencies:
              - git-clone
          - name: build
            template: build
            dependencies:
              - git-clone
              - ls
          - name: trivy-image-scan
            template: trivy-image-scan
            dependencies:
              - build
          - name: trivy-filesystem-scan
            template: trivy-filesystem-scan
            dependencies:
              - build
          - name: push-image
            template: push-image
            when: " == true"
            dependencies:
              - trivy-filesystem-scan
              - trivy-image-scan
</pre></table></code></div></div><p>Above, under <code class="language-plaintext highlighter-rouge">templates:</code> is where the actual tasks are defined. You can see here that the first template is named <code class="language-plaintext highlighter-rouge">ci</code>, which matches the <code class="language-plaintext highlighter-rouge">entrypoint</code> specified earlier. That means that unless overridden, this step <code class="language-plaintext highlighter-rouge">ci</code> will be executed when you run the workflow.</p><p>You can also see that this is a <code class="language-plaintext highlighter-rouge">dag</code>. I have listed out all the other templates, or tasks to be performed as well as their dependencies. When any task has all of its dependencies complete, it will immediately begin execution. In this workflow, it looks a bit like this: <a href="/assets/images/argo-workflows-dag.png" class="popup img-link "><img data-src="/assets/images/argo-workflows-dag.png" alt="argo-workflows-dag" class="lazyload" data-proofer-ignore></a></p><p>You can see that <code class="language-plaintext highlighter-rouge">git-clone</code> is the first step, followed by <code class="language-plaintext highlighter-rouge">ls</code>. <code class="language-plaintext highlighter-rouge">build</code> needs to wait for both of those steps, next up are the two trivy scans. <code class="language-plaintext highlighter-rouge">trivy-image-scan</code> depends on the build stage, as it is scanning the actual docker image. On the other hand, <code class="language-plaintext highlighter-rouge">trivy-filesystem-scan</code> can begin executing immediately after the git clone. Once both are complete <code class="language-plaintext highlighter-rouge">push-image</code> can begin execution, provided that <code class="language-plaintext highlighter-rouge">workflow.parameters.push-image</code> is set to <code class="language-plaintext highlighter-rouge">true</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>    - name: git-clone
      inputs:
        parameters:
          - name: repo
            value: ""
          - name: revision
            value: ""
        artifacts:
          - name: argo-source
            path: /src
            git:
              repo: ""
              revision: ""
      container:
        image: alpine:3.17
        command:
          - sh
          - -c
        args:
          - cp -r /src/* .
        workingDir: /workdir
        volumeMounts:
          - name: workdir
            mountPath: /workdir
</pre></table></code></div></div><p>This clones the repo specified by the parameters above, as well as the branch or ref specified in <code class="language-plaintext highlighter-rouge">revision</code>. It then copies the downloaded source onto a volume mount so that it can be seamlessly passed between other tasks in this workflow.</p><p>There is a step called <code class="language-plaintext highlighter-rouge">ls</code> that is mainly included just for log output and to show how simple tasks can be performed.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>    - name: build
      inputs:
        parameters:
          - name: oci-image
            value: ""
          - name: oci-tag
            value: ""
      container:
        image: gcr.io/kaniko-project/executor:latest
        args:
          - --context=/workdir
          - --destination=:
          - --no-push
          - --tar-path=/workdir/.tar
        workingDir: /workdir
        volumeMounts:
          - name: workdir
            mountPath: /workdir
</pre></table></code></div></div><p>In this step, I use Kaniko to build the image. Kaniko is a tool for building OCI/Docker images inside of Kubernetes. It avoids many of the pitfalls of running Docker in Docker (or in this case Docker in containerd). As you can see, it also doesnâ€™t require <code class="language-plaintext highlighter-rouge">root</code> privilege. I also specify output to the volume mount as a tar file, so that it can be used in downstream tasks.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>    - name: trivy-image-scan
      inputs:
        parameters:
          - name: oci-tag
            value: ""
      container:
        image: aquasec/trivy
        args:
          - image
          - --input=/workdir/.tar
        env:
          - name: DOCKER_HOST
            value: tcp://127.0.0.1:2375
        volumeMounts:
          - name: workdir
            mountPath: /workdir
      sidecars:
        - name: dind
          image: docker:23.0.1-dind
          command:
            - dockerd-entrypoint.sh
          env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
          securityContext:
            privileged: true
          mirrorVolumeMounts: true
</pre></table></code></div></div><p>In this step, I use Trivy to scan the previously built docker image. Trivy requires Docker, so how are we going to do that inside of this workflow? You can see that in the main Trivy container I specify the standard docker environment variable of <code class="language-plaintext highlighter-rouge">DOCKER_HOST</code> I point this to <code class="language-plaintext highlighter-rouge">localhost</code> which refers to the sidecar running the official <code class="language-plaintext highlighter-rouge">docker:23.0.1-dind</code> image. You can see that this requires <code class="language-plaintext highlighter-rouge">privileged</code> access to execute successfully, one of the many issues with running Docker in Docker.</p><p>Next, I run a Trivy filesystem scan of the cloned source repo. I will skip explaining this step.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>    - name: push-image
      inputs:
        parameters:
          - name: oci-tag
            value: ""
          - name: oci-image
            value: ""
          - name: oci-registry
            value: ""
      script:
        image: gcr.io/go-containerregistry/crane:debug
        env:
          - name: OCI_REGISTRY_USER
            valueFrom:
              secretKeyRef:
                name: registry-credentials
                key: username
          - name: OCI_REGISTRY_PASSWORD
            valueFrom:
              secretKeyRef:
                name: registry-credentials
                key: password
        command:
          - sh
        source: &gt;
          crane auth login -u $OCI_REGISTRY_USER -p $OCI_REGISTRY_PASSWORD 
          crane push /workdir/.tar /:
        volumeMounts:
          - name: workdir
            mountPath: /workdir
</pre></table></code></div></div><p>Finally, I use <code class="language-plaintext highlighter-rouge">crane</code> to push the newly built and scanned image to an OCI or Docker registry. In this step, I use the <code class="language-plaintext highlighter-rouge">source</code> command to specify that I am executing an inline script instead of a command and arguments. I mount a secret into the environment and then reference those credentials as environment variables. You will see that it is also possible to reference inputs and parameters directly inside of an inline script.</p><h3 id="submitting-the-workflow"><span class="mr-2">Submitting the workflow:</span><a href="#submitting-the-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>From the UI, itâ€™s fairly straight forward. From the command line, it looks a bit like this: <code class="language-plaintext highlighter-rouge">argo submit --from workflowtemplate/ci-template -p repo="https://github.com/mikenabhan/proxmox-kubernetes-cluster-autoscaler.git" -p revision="main" -p oci-image="mikenabhan/proxmox-kubernetes-cluster-autoscaler" -p oci-tag="test-tag" -p push-image="false" --watch</code></p><p>Thatâ€™s it, youâ€™ve now built a docker image using Argo Workflows, Kaniko, and scanned it for security vulnerabilities using Trivy. All in a cloud-agnostic manner.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Build%20a%20docker%20image%20with%20Argo%20Workflows%20-%20Mike%20Nabhan&url=https%3A%2F%2Fmikenabhan.com%2Fposts%2Fbuild-docker-image-argo-workflows%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Build%20a%20docker%20image%20with%20Argo%20Workflows%20-%20Mike%20Nabhan&u=https%3A%2F%2Fmikenabhan.com%2Fposts%2Fbuild-docker-image-argo-workflows%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmikenabhan.com%2Fposts%2Fbuild-docker-image-argo-workflows%2F&text=Build%20a%20docker%20image%20with%20Argo%20Workflows%20-%20Mike%20Nabhan" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/solar-powered-kubernetes-cluster/">The Solar Powered Kubernetes Cluster</a><li><a href="/posts/build-docker-image-argo-workflows/">Build a docker image with Argo Workflows</a></ul></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/solar-powered-kubernetes-cluster/"><div class="card-body"> <em class="small" data-ts="1691992800" data-df="ll" > Aug 14, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The Solar Powered Kubernetes Cluster</h3><div class="text-muted small"><p> The Solar Powered Kubernetes Cluster This post is the first part in a series. The purpose of this series is to show that on-prem/private cloud/self-hosted kubernetes doesnâ€™t have to be hard and y...</p></div></div></a></div><div class="card"> <a href="/posts/esphome-home-assistant-geiger-counter-esp8266/"><div class="card-body"> <em class="small" data-ts="1607670000" data-df="ll" > Dec 11, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Making a Geiger Counter with ESPHome and Home Assistant</h3><div class="text-muted small"><p> Making a Geiger Counter with ESPHome and Home Assistant After a discussion with a friend about ridiculous things to hook up to a Home Automation system, I figured it out. Hardware and Prerequisit...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/esphome-home-assistant-geiger-counter-esp8266/" class="btn btn-outline-primary" prompt="Older"><p>Making a Geiger Counter with ESPHome and Home Assistant</p></a> <a href="/posts/solar-powered-kubernetes-cluster/" class="btn btn-outline-primary" prompt="Newer"><p>The Solar Powered Kubernetes Cluster</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> Â© 2023 <a href="https://twitter.com/mikenabhan">Mike Nabhan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
